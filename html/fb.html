<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Test</title>
</head>
<link rel="stylesheet" type="text/css" href="semantic/semantic.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
<script
  src="https://code.jquery.com/jquery-3.1.1.min.js"
  integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
  crossorigin="anonymous">
</script>
<script src="https://momentjs.com/downloads/moment.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="semantic/semantic.min.js"></script>
<body>
    <div class="ui container segment">
        <div class="ui input">
            <input type="text" name="keyword" id="keyword" placeholder="關鍵字" value="電影">
            <input type="text" name="start" id="start" value="3">
            <input type="text" name="end" id="end" value="4">
            <input type="text" name="threshold" id="threshold" value="0.7">
        </div>
        <button class="ui primary button" name="submit" onclick="query()">查詢</button>
        <br><br>
        <!-- <div class="ui segment">
            <div class="ui dropdown">
                <div ckass="text"></div>
                <i class="dropdown icon"></i>
            </div>
        </div> -->
        <table class="display" id="main">
            <thead>
                <tr>
                    <th>id</th>
                    <th>name</th>
                    <th>category</th>
                    <th>tag</th>
                    <th>relation</th>
                    <th>likes</th>
                    <th>comments</th>
                    <th>total_comments</th>
                    <th>posts</th>
                    <th>total_posts</th>
                    <th>comments/posts</th>
                    <th>score</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <br><br>
        <div id="object">
            <h3 class="ui header" id="object_name"></h3>
            <canvas id="chart" witdh="400" height="200"></canvas>
            <table class="display" id="sub">
                <thead>
                    <tr>
                        <th>id</th>
                        <th>type</th>
                        <th>relation</th>
                        <th>likes</th>
                        <th>comments</th>
                        <th>normalized_comments_count</th>
                        <th>score</th>
                        <th>datetime</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</body>
<script>
    let MAIN_TABLE = null;
    let SUB_TABLE = null;
    
    window.chartColors = {
        red: 'rgb(255, 99, 132)',
        orange: 'rgb(255, 159, 64)',
        yellow: 'rgb(255, 205, 86)',
        green: 'rgb(75, 192, 192)',
        blue: 'rgb(54, 162, 235)',
        purple: 'rgb(153, 102, 255)',
        grey: 'rgb(201, 203, 207)'
    };

    let config = null;
    $( document ).ready(() => {
        let color = Chart.helpers.color

        MAIN_TABLE = $("#main").DataTable({
                "paging": true,
                "info": true,
                "searching": true,
                "bSort": false,
                // "data": [{
                //     "avg_comments_count": "359.67",
                //     "comments_count": 1079,
                //     "id": "124616330906800",
                //     "name": '<a href="#object" onclick="select(' + "124616330906800" + ')">' + "東森新聞" + '</a>',
                //     "posts_count": 3,
                //     "relation": 0.001617900029649759,
                //     "total_comments_count": 358441,
                //     "total_posts_count": 4664,
                //     "score": 1000,
                // }],
                "columns": [
                    {
                        "data": "id",
                        "render": ( data, type, row, meta ) => {
                            if (type === "display") {
                                let link = "https://facebook.com/" + data
                                data = '<a href="' + link + '">' + data + '</a>'
                            }
                            return data
                        }
                    },
                    { "data": "name", },
                    { "data": "category" },
                    { "data": "tag" },
                    { "data": "relation" },
                    { "data": "likes_count" },
                    { "data": "comments_count" },
                    { "data": "total_comments_count" },
                    { "data": "posts_count" },
                    { "data": "total_posts_count" },
                    { "data": "avg_comments_count" },
                    { "data": "score"}
                ]
            })
        SUB_TABLE = $("#sub").DataTable({
                "paging": true,
                "info": true,
                "searching": true,
                "bSort": false,
                "columns": [
                    {
                        "data": "id",
                        "render": ( data, type, row, meta ) => {
                            if (type === "display") {
                                let link = "https://facebook.com/" + data
                                data = '<a href="' + link + '">' + data + '</a>'
                            }
                            return data
                        }
                    },
                    { "data": "type" },
                    { "data": "relation" },
                    { "data": "likes_count" },
                    { "data": "comments_count" },
                    { "data": "normalized_comments_count"},
                    { "data": "score" },
                    { "data": "datetime"}
                ]
        })
    })
    const select = (index) => {
        SUB_TABLE.clear()
        let object_id = window.response.data[index]['id']
        let object_name = window.response.data[index]['name']
        let ctx = $("#chart")[0].getContext("2d")
        let color = Chart.helpers.color
        let datasets = [{
                label: "relation",
                backgroundColor: color(window.chartColors.red).alpha(0.5).rgbString(),
                borderColor: window.chartColors.red,
                fill: false,
                data: [],
                lineTension: 0,
            }, {
                label: "comments",
                backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
                borderColor: window.chartColors.blue,
                fill: false,
                data: [],
                lineTension: 0,
        }, {
                label: "score",
                backgroundColor: color(window.chartColors.yellow).alpha(0.5).rgbString(),
                borderColor: window.chartColors.yellow,
                fill: false,
                data: [],
                lineTension: 0,
        }]
        $("#object_name").text(object_name)
        for (let [key, value] of Object.entries(window.response.history[object_id])) {
            SUB_TABLE.row.add({
                "id": key,
                "type": value['type'],
                "relation": value['relation'],
                "likes_count": value['likes_count'],
                "comments_count": value['comments_count'],
                "normalized_comments_count": value['normalized_comments_count'],
                "score": value['score'],
                "datetime": moment(value['datetime_pub']["$date"]).format('lll')
            }).draw( false )
            // relation curve
            datasets[0]['data'].push({y: value['relation'], x: moment(value['datetime_pub']["$date"]).toDate()})
            // comments_count curve
            datasets[1]['data'].push({y: value['normalized_comments_count'], x: moment(value['datetime_pub']["$date"]).toDate()})
            datasets[2]['data'].push({y: value['score'], x: moment(value['datetime_pub']["$date"]).toDate()})
        }

        window.myLine = new Chart(ctx, {
            type: "line",
            data: {'datasets': datasets},
            options: {
				responsive: true,
				title: {
					display: true,
					text: 'Comments & Relation'
				},
				scales: {
					xAxes: [{
						type: 'time',
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'Date'
						},
						ticks: {
							major: {
								fontStyle: 'bold',
								fontColor: '#FF0000'
							}
						}
					}],
					yAxes: [{
						display: true,
						scaleLabel: {
							display: true,
							labelString: 'value'
						}
					}]
				}
			}
        })
    }
    const query = () => {
        $(".ui.segment").dimmer("show")
        let data ={
            keyword: $('#keyword')[0].value,
            start: $('#start')[0].value,
            end: $('#end')[0].value,
            threshold: $('#threshold')[0].value,
        }
        console.log(data)
        let requestOptions = {
            headers: {'Content-Type': 'application/json'},
            method: 'POST',
            body: JSON.stringify(data)
        }
        const query_entity =  fetch('http://localhost:8000/api/query/fb/', requestOptions).then(
            response => {
                    // if (!response.ok) {
                    //     return Promise.reject(response.statusText)
                    // }
                    return response.json()
            }
        ).then( result => {
            MAIN_TABLE.clear()
            window.response = result
            result.data.map(( value, index ) => {
                let row = Object.assign({}, value)
                row["name"] = `<a href="#object" onclick=select(${index})>${value['name']}</a>`
                MAIN_TABLE.row.add(row).draw( false )
            })
            $(".ui.segment").dimmer("hide")
            console.log(result)
            
        })
    }

</script>
</html>